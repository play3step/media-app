<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media App</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../styles/record.css">
</head>

<body>
    <div id="wrap">
        <div id="background_img">
            <button id="btn_exit">
                <img src="../png/exit_button.png">
            </button>
            <div id="record_cover">
                <div id="tone"></div>
                <div id="tone_arm"></div>
            </div>
            <div id="play_list" class="list_container">
                <div id="list_item">
                    <span class="title"></span>
                </div>
            </div>
            <div id="controller_box">
                <div id="music_controller">
                    <div id="prograss_bar">
                        <div id="current_bar"></div>
                    </div>
                    <button id="btn_prev">
                        <img src="../png/skip_previous.png">
                    </button>
                    <button id="btn_play">
                        <img src="../png/play_arrow.png">
                    </button>
                    <button id="btn_next">
                        <img src="../png/skip_next.png">
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
<script type="module">
    // 재생 목록 데이터
    import { musicData } from "../data/data.js"
    console.log(musicData)

    // 현재 재생중인 오디오
    let image = musicData[0].image
    let title = musicData[0].title
    let author = musicData[0].author
    let audio = new Audio(musicData[0].audio);
    let toggleAlbume = false;
    let toggleTonearm = false;

    $('.list_container').css("background-image", `url(${image})`);
    let listDiv = $("#play_list")
    for (let i = 0; i < 3; i++) {
        let title = musicData[i].title

        let list_item = $('<div class = "list_item">');
        list_item.append('<span class = "title">' + title + '</span>');
        listDiv.append(list_item)
    }


    function toggleToneArm() {
        if (!toggleTonearm) {
            $(this).css({ 'transform': 'rotateZ(45deg)' });
            $(this).css({ 'left': '814px' });
            $(this).css({ 'top': '6px' })
            event.stopPropagation();
            toggleTonearm = true;
        }
        else {
            $(this).css({ 'transform': 'rotateZ(0deg)' });
            $(this).css({ 'left': '771px' });
            event.stopPropagation();
            toggleTonearm = false;
        }
    }
    $(document).ready(function () {
        $("#btn_exit").click(function(){
            window.location.href = "./index.html"
        })
        $("#tone_arm").click(function () {
            let btnPlay = $('#btn_play');
            let btnPlayImg = btnPlay.find('img');
            btnPlayImg.remove();

            if (!toggleTonearm) {
                $(this).css({ 'transform': 'rotateZ(45deg)' });
                $(this).css({ 'left': '814px' });
                $(this).css({ 'top': '6px' });

                event.stopPropagation();
                toggleTonearm = true;
                currentAudio.play();
                btnPlayImg.attr('src', '../png/stop_button.png').appendTo('#btn_play');
            } else {
                $(this).css({ 'transform': 'rotateZ(0deg)' });
                $(this).css({ 'left': '771px' });
                event.stopPropagation();
                toggleTonearm = false;
                currentAudio.pause();
                btnPlayImg.attr('src', '../png/play_arrow.png').appendTo('#btn_play');
            }
        });

        $('#record_cover').click(function () {
            $(this).css({ 'transform': 'rotateX(180deg)' })
        })

        $(".list_container").click(function (event) {
            event.stopPropagation();
            if (!toggleAlbume) {
                $(this).animate({
                    rotate: "5deg"
                }, 500).animate({
                    'left': '1640px'
                });
                toggleAlbume = true;
            } else {
                $(this).animate({
                    'left': '1440px'
                }, 500).animate({
                    rotate: "-5deg"
                });
                toggleAlbume = false;
            }
        });

        let currentAudio = audio;

        $('#btn_play').click(function () {
            let btnPlay = $('#btn_play');
            let btnPlayImg = btnPlay.find('img');
            btnPlayImg.remove();
            if (currentAudio.paused) {
                $("#tone_arm").css({ 'transform': 'rotateZ(45deg)' });
                $("#tone_arm").css({ 'left': '814px' });
                $("#tone_arm").css({ 'top': '6px' })
                btnPlayImg.attr('src', '../png/stop_button.png').appendTo('#btn_play');
                event.stopPropagation();
                toggleTonearm = true;
                currentAudio.play();
            } else {
                $("#tone_arm").css({ 'transform': 'rotateZ(0deg)' });
                $("#tone_arm").css({ 'left': '771px' });
                btnPlayImg.attr('src', '../png/play_arrow.png').appendTo('#btn_play');
                event.stopPropagation();
                toggleTonearm = false;
                currentAudio.pause();
            }
        });

        $('#btn_prev').click(function () {
            let currentIndex = musicData.findIndex(item => item.audio === currentAudio.src);
            let prevIndex = (currentIndex - 1 + musicData.length + 1) % musicData.length;
            changeAudio(prevIndex);
        });

        $('#btn_next').click(function () {
            let currentIndex = musicData.findIndex(item => item.audio === currentAudio.src);
            let nextIndex = (currentIndex + 1) % musicData.length + 1;
            changeAudio(nextIndex);
        });

        function changeAudio(index) {
            let newAudio = new Audio(musicData[index].audio);
            newAudio.addEventListener('loadedmetadata', function () {
                currentAudio.pause();
                currentAudio = newAudio;
                currentAudio.play();
            });
        }
        $('.title').click(function (event) {
            event.stopPropagation();
            $(this).css('color', 'red');
            let title = $(this).text();
            let newAudio;
            for (let i = 0; i < musicData.length; i++) {
                if (musicData[i].title === title) {
                    newAudio = new Audio(musicData[i].audio);
                    break;
                }
            }
            if (newAudio) {
                if (currentAudio) {
                    currentAudio.pause();
                }
                newAudio.play();
                currentAudio = newAudio;
            }
        }).hover(
            function () {
                $(this).css('color', 'red');
            },
            function () {
                $(this).css('color', 'black');
            }
        );

    });


</script>

</html>