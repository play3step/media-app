<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media App</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../styles/record.css">
</head>

<body>
    <div id="wrap">
        <div id="background_img">
            <button id="btn_exit">
                <img src="../png/exit_button.png">
            </button>
            <div id="record_cover">
                <div id="tone"></div>
                <div id="tone_arm"></div>
            </div>
            <div id="play_list" class="list_container">
                <div id="list_item">
                    <span class="title"></span>
                </div>
            </div>
            <div id="controller_box">
                <div id="music_controller">
                    <div id="progress_bar_container">
                        <span id="current_time_display">0:00</span>
                        <div id="progress_bar">
                            <div id="progress_indicator"></div>
                        </div>
                        <span id="total_time_display">-2:56</span>
                    </div>
                    <div id="prograss_bar">
                        <div id="current_time"></div>
                        <div id="current_bar"></div>
                        <div id="total_time"></div>
                    </div>
                    <div style="display: flex; flex-direction: row;">
                        <button id="btn_prev">
                            <img src="../png/skip_previous.png">
                        </button>
                        <button id="btn_play">
                            <img src="../png/play_arrow.png">
                        </button>
                        <button id="btn_next">
                            <img src="../png/skip_next.png">
                        </button>
                    </div>


                </div>
            </div>
        </div>
    </div>

</body>
<script type="module">
    import { musicData } from "../data/data.js";
    let urlParams = new URLSearchParams(window.location.search);
    let themeId = urlParams.get('themeId');
    let currentAlbum = musicData[Number(themeId-1)];

    // 현재 재생 중인 오디오
    let albumTitle = currentAlbum.albume_title;
    let albumImage = currentAlbum.albume_image;
    let firstSong = currentAlbum.songs[0];
    let title = firstSong.title;
    let author = firstSong.author;
    let audio = new Audio(firstSong.audio);
    let toggleTonearm = false;

    $('.list_container').css("background-image", `url(${albumImage})`);
    let listDiv = $("#play_list");
    let listItem = $('<div class="list_item">');
    // 재생 목록에 추가
    for (let i = 0; i < currentAlbum.songs.length; i++) {
        let title = currentAlbum.songs[i].title;


        listItem.append('<h2 class="title">' + title + '</h2>');
        listDiv.append(listItem);
    }
    $(document).ready(function () {

        $("#btn_exit").click(function () {
            window.location.href = "./index.html"
        })
        $("#tone_arm").click(function () {
            let btnPlay = $('#btn_play');
            let btnPlayImg = btnPlay.find('img');
            btnPlayImg.remove();

            if (!toggleTonearm) {
                $(this).css({ 'transform': 'rotateZ(45deg)' });
                $(this).css({ 'left': '814px' });
                $(this).css({ 'top': '6px' });

                event.stopPropagation();
                toggleTonearm = true;
                currentAudio.play();
                btnPlayImg.attr('src', '../png/stop_button.png').appendTo('#btn_play');
            } else {
                $(this).css({ 'transform': 'rotateZ(0deg)' });
                $(this).css({ 'left': '771px' });
                event.stopPropagation();
                toggleTonearm = false;
                currentAudio.pause();
                btnPlayImg.attr('src', '../png/play_arrow.png').appendTo('#btn_play');
            }
        });
        let isOpened = false;
        $('#record_cover').click(function () {
            if (!isOpened) {
                $(this).css({ 'transform': 'rotateX(180deg)' })
                //$(this).css({'background':'royalblue'});
                $("#tone_arm").css({ 'visibility': 'hidden' }).fadeOut(500);
                $("#tone").css({ 'visibility': 'hidden' }).fadeOut(500);
                isOpened = true;
            } else {
                $(this).css({ 'transform': 'rotateX(0deg)' }).delay(500);
                setTimeout(function () {
                    $("#tone_arm, #tone").css({ 'visibility': 'visible' }).fadeIn(500);
                }, 500);

                isOpened = false;
            }
        })
        $(".list_container").animate({
            'left': '1240px',
            'rotate': '5deg'
        }, 500).animate({
            'rotate': '-5deg'
        });
        $('#btn_play').click(function () {
            let btnPlay = $('#btn_play');
            let btnPlayImg = btnPlay.find('img');
            btnPlayImg.remove();

            if (currentAudio.paused) {
                $("#tone_arm").css({ 'transform': 'rotateZ(45deg)' });
                $("#tone_arm").css({ 'left': '814px' });
                $("#tone_arm").css({ 'top': '6px' });
                btnPlayImg.attr('src', '../png/stop_button.png').appendTo('#btn_play');
                event.stopPropagation();
                toggleTonearm = true;
                currentAudio.play();
                getCurrentTitle(title);
            } else {
                $("#tone_arm").css({ 'transform': 'rotateZ(0deg)' });
                $("#tone_arm").css({ 'left': '771px' });
                btnPlayImg.attr('src', '../png/play_arrow.png').appendTo('#btn_play');
                event.stopPropagation();
                toggleTonearm = false;
                currentAudio.pause();
            }
        });
        $('#btn_next').click(function () {
            playNextSong();
        });

        $('#btn_prev').click(function () {
            playPreviousSong();
        });

        function playNextSong() {
            let currentIndex = currentAlbum.songs.findIndex(song => song.title === title);
            let nextIndex = (currentIndex + 1) % currentAlbum.songs.length;
            playSongByIndex(nextIndex);
        }

        function playPreviousSong() {
            let currentIndex = currentAlbum.songs.findIndex(song => song.title === title);
            let prevIndex = (currentIndex - 1 + currentAlbum.songs.length) % currentAlbum.songs.length;
            playSongByIndex(prevIndex);
        }

        function playSongByIndex(index) {
            let selectedSong = currentAlbum.songs[index];
            title = selectedSong.title;
            author = selectedSong.author;
            let newAudio = new Audio(selectedSong.audio);

            $('.title').css('color', '');

            $('.title:contains("' + title + '")').css('color', 'red');

            if (currentAudio) {
                currentAudio.pause();
            }

            newAudio.play();
            currentAudio = newAudio;
        }
        function getCurrentTitle(current_title) {
            for (let i = 0; i < musicData.length; i++) {
                let album = musicData[i];
                for (let j = 0; j < album.songs.length; j++) {
                    let song = album.songs[j];

                    if (song.title === current_title) {
                        console.log(song.title)
                        $('.title').eq(j + 1).css('color', 'red');
                        break;
                    }
                }
            }
        }

        let currentAudio = audio

        $('.title').click(function (event) {
            event.stopPropagation();

            // Remove red color from all titles
            $('.title').css('color', '');

            // Set the clicked title to red
            $(this).css('color', 'red');
            let index = $(this).index();
            let clickedTitle = $('.title').text();
            let newAudio;

            // musicData 배열을 순회하며 클릭된 제목과 일치하는 곡을 찾음
            for (let i = 0; i < musicData.length; i++) {
                let album = musicData[i];
                for (let j = 0; j < album.songs.length; j++) {
                    let song = album.songs[j];
                    if (song.title === clickedTitle) {
                        newAudio = new Audio(song.audio);
                        break;
                    }
                }
                if (newAudio) {
                    break;
                }
            }

            if (newAudio) {
                if (currentAudio) {
                    currentAudio.pause();
                }
                newAudio.play();
                currentAudio = newAudio;
            }
        });



    });


</script>

</html>